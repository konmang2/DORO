<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í€´ì¦ˆ</title>
  <style>
    @keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-10px); }
  40%, 80% { transform: translateX(10px); }
}
.shake {
  animation: shake 0.5s;
}
if (!ok) {
  const quizEl = document.getElementById('quiz');
  quizEl.classList.add('shake');
  quizEl.addEventListener('animationend', () => {
    quizEl.classList.remove('shake');
  }, { once: true });
}
body { font-family: Arial, sans-serif; background: linear-gradient(#e0eafc, #cfdef3); margin: 0; padding: 0; text-align: center; }
    #header { margin-top: 20px; display: flex; justify-content: center; align-items: baseline; }
    h1#title { font-size: 32px; margin: 0; }
    #selectedCats { font-size: 18px; margin-left: 20px; color: #555; display: none; }
    .category { margin: 10px; display: inline-block; padding: 15px 30px; border: 2px solid black; border-radius: 10px; cursor: pointer; font-size: 18px; background: white; }
    .category.active { background: #a0d8ef; }
    .category:hover { background: #f0f0f0; }
    #quiz, #result, #startBtn { display: none; }
    img { max-width: 100%; height: auto; margin-top: 10px; }
    .option { margin: 10px; padding: 10px; border: none; background: white; font-size: 18px; cursor: pointer; }
    .option:hover { background: #ddd; }
    button { margin: 10px; padding: 10px 20px; font-size: 18px; cursor: pointer; }
    #answerInput { margin-top: 15px; padding: 10px; width: 200px; font-size: 16px; }
    .explanation { margin-top: 20px; font-size: 24px; }
    .drop-container { display: flex; justify-content: center; margin-top: 10px; }
    .drop-slot { width: 160px; height: 160px; border: 2px dashed #aaa; margin: 0 5px; display: flex; align-items: center; justify-content: center; }
    .drop-slot img { width: 150px; }
    .drag-container { display: flex; justify-content: center; margin-top: 10px; }
    .drag-item { width: 150px; cursor: move; margin: 0 5px; }
    #audioPlayer { display: none; width: 300px; margin-top: 10px; }
    #timer { font-size: 20px; color: red; margin-top: 10px; }
    #startBtn { margin-top: 20px; display: block; }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <div id="header">
    <h1 id="title">ë‹¹ì‹ ì€ ëˆ„êµ¬ì‹ ê°€ìš”?</h1>
    <span id="selectedCats"></span>
  </div>
  <div id="categorySelection">
    <div class="category" onclick="toggleCategory('ì—¬í–‰ì', this)">ì—¬í–‰ì</div>
    <div class="category" onclick="toggleCategory('ê°œì²™ì', this)">ê°œì²™ì</div>
    <div class="category" onclick="toggleCategory('ë¡œí”„ê¾¼', this)">ë¡œí”„ê¾¼</div>
    <div class="category" onclick="toggleCategory('ë°©ë‘ì', this)">ë°©ë‘ì</div>
    <div class="category" onclick="toggleCategory('ë‹¨í…Œ', this)">ë‹¨í…Œ</div>
    <div class="category" onclick="toggleCategory('ì„ ìƒë‹˜', this)">ì„ ìƒë‹˜</div>
    <div class="category" onclick="toggleCategory('êµì£¼', this)">êµì£¼</div>
    <div class="category" onclick="toggleCategory('íŠ¸ë ˆì´ë„ˆ', this)">íŠ¸ë ˆì´ë„ˆ</div>
    <div class="category" onclick="toggleCategory('ë‹¥í„°', this)">ë‹¥í„°</div>
    <div class="category" onclick="toggleCategory('ì§€íœ˜ê´€(ë‹ˆì¼€)', this)">ì§€íœ˜ê´€(ë‹ˆì¼€)</div>
    <div class="category" onclick="toggleCategory('ì§€íœ˜ê´€(ì†Œì „)', this)">ì§€íœ˜ê´€(ì†Œì „)</div>
  </div>
  <div id="startBtn"><button onclick="startQuiz()">í€´ì¦ˆ ì‹œì‘</button></div>
  <div id="quiz">
    <div id="counter" style="margin-bottom:10px; font-weight:bold;"></div>
  </div>
  <div id="result"></div>
  <audio id="audioPlayer" controls></audio>

  <script src="quiz-data.js"></script>

  <!-- 2) ì¹´ìš´í„° & ë Œë”ë§ ë¡œì§ + ê¸°ì¡´ í€´ì¦ˆ ë¡œì§ -->
  <script>
    const counterEl = document.getElementById('counter');
    let currentQuestion = 0;
    let selectedCategories = [],
        score = 0,
        scoreByCategory = {},
        shuffledQuestions = [],
        timer, timeLeft, answered = false, lastOk = false;

    function renderQuestion(idx) {
      const total = shuffledQuestions.length;
      const remaining = total - idx;
      counterEl.textContent = `ë¬¸ì œ ${idx+1}/${total} (ë‚¨ì€ ${remaining}ë¬¸ì œ)`;
      showQuestion();
    }

    function toggleCategory(cat, el) {
      const idx = selectedCategories.indexOf(cat);
      if (idx === -1) { selectedCategories.push(cat); el.classList.add('active'); }
      else           { selectedCategories.splice(idx,1); el.classList.remove('active'); }
    }

    function startQuiz() {
      if (!selectedCategories.length) return;
      shuffledQuestions = data
        .filter(q => selectedCategories.includes(q.category))
        .sort(() => Math.random() - 0.5);
      score = 0;
      scoreByCategory = {};
      selectedCategories.forEach(c => scoreByCategory[c] = 0);
      document.getElementById('selectedCats').innerText = 'ì„ íƒ: ' + selectedCategories.join(', ');
      document.getElementById('selectedCats').style.display = 'inline-block';
      document.getElementById('categorySelection').style.display = 'none';
      document.getElementById('startBtn').style.display = 'none';
      document.getElementById('quiz').style.display = 'block';
      currentQuestion = 0;
      renderQuestion(0);
    }

    function showQuestion() {
      clearInterval(timer);
      answered = false;
      if (currentQuestion >= shuffledQuestions.length) return showResult();

      const q = shuffledQuestions[currentQuestion];
      document.getElementById('title').innerText = q.category;

      let html = `<h2>${q.question}</h2>`;
      html += `<div id='timer'>ë‚¨ì€ ì‹œê°„: ${q.timer}ì´ˆ</div>`;
      if (q.audio) html += `<button onclick="playAudio('${q.audio}')">ğŸ”Š ì¬ìƒ</button>`;

      if (q.type === 'ê°ê´€ì‹') {
        q.options.forEach((opt,i) =>
          html += `<div class='option' onclick='checkAnswer(${i})'>${opt}</div>`
        );
      }
      else if (q.type === 'ìˆœì„œ') {
        html += `<div class='drag-container'>`;
        q.options.forEach((img,i) =>
          html += `<img class='drag-item' src='${img}' draggable='true' ondragstart='dragStart(event)' data-index='${i}'>`
        );
        html += `</div><div class='drop-container'>`;
        q.options.forEach(() =>
          html += `<div class='drop-slot' ondragover='allowDrop(event)' ondrop='drop(event)'></div>`
        );
        html += `</div>`;
      }
      else {
        if (q.image) {
          html += `<div style='display:flex;justify-content:center;align-items:center;'>
                     <img src='${q.image}' style='width:300px;margin-right:10px;'>
                     <img id='reveal-img' src='' style='width:300px;display:none;margin-left:10px;'>
                   </div>`;
        }
        html += `<input id='answerInput'><br>`;
      }

      html += `<button onclick='checkAnswer()'>ì œì¶œ</button>`;
      document.getElementById('quiz').innerHTML = html;

      startTimer();
    }

    function checkMultiple(userAnswers, q) {
      const uniqueAns = Array.from(new Set(userAnswers));
      if (uniqueAns.length !== q.requiredCount) return false;
      return uniqueAns.every(ans => q.answerPool.includes(ans));
    }

    function checkAnswer(sel=null) {
      if (answered) return;
      answered = true;
      clearInterval(timer);
      disableInputs();

      const q = shuffledQuestions[currentQuestion];
      let ok = false;
      const raw  = (document.getElementById('answerInput')?.value || '').toLowerCase();
      const norm = raw.replace(/\s|,/g, '');

      if (q.type === 'ê°ê´€ì‹') {
        ok = q.answer.includes(sel);
      }
      else if (q.type === 'ìˆœì„œ') {
        const placed = Array.from(document.querySelectorAll('.drop-slot img'))
                             .map(i => +i.dataset.index);
        ok = JSON.stringify(placed) === JSON.stringify(q.answerOrder);
      }
      else if (q.answerText) {
        ok = norm === q.answerText.toLowerCase().replace(/\s|,/g, '');
      }
      else if (q.type === 'multiple') {
        ok = checkMultiple(getUserMultipleAnswers(), q);
      }
      else if (q.answer) {
        const arr = q.answer.map(a => a.toLowerCase().replace(/\s|,/g,''));
        ok = arr.every(a => norm.includes(a));
      }

      lastOk = ok;
      if (ok) {
        score++;
        scoreByCategory[q.category]++;
      }
      showAnswer();
    }

    function showAnswer() {
      const q = shuffledQuestions[currentQuestion];
      const ansHtml = q.answerText ? `<div style='margin-top:10px;'>ì •ë‹µ: ${q.answerText}</div>` : '';
      const expHtml = q.explanation
        ? `<div style='margin-top:10px;color:#555;white-space:pre-wrap;'>
             í•´ì„¤:<br>${q.explanation.replace(/\n/g,'<br>')}
           </div>`
        : '';

      document.getElementById('quiz').innerHTML += `
        <div class='explanation'>
          ${lastOk?'âœ…':'âŒ'}${ansHtml}${expHtml}<br>
          <button onclick='nextQuestion()'>ë‹¤ìŒ ë¬¸ì œ</button>
        </div>`;

      const rev = document.getElementById('reveal-img');
      if (q.revealImage && rev) {
        rev.src = q.revealImage;
        rev.style.display = 'block';
      }
    }

    function startTimer() {
      timeLeft = shuffledQuestions[currentQuestion].timer;
      document.getElementById('timer').innerText = `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ`;
      timer = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').innerText = `ë‚¨ì€ ì‹œê°„: ${timeLeft}ì´ˆ`;
        if (timeLeft <= 0) {
          clearInterval(timer);
          answered = true;
          disableInputs();
          lastOk = false;
          showAnswer();
        }
      }, 1000);
    }

    function disableInputs() {
      document.querySelectorAll('.option').forEach(el => el.onclick = null);
      const btn = document.querySelector('#quiz button');
      if (btn) btn.disabled = true;
    }

    function nextQuestion() {
      currentQuestion++;
      renderQuestion(currentQuestion);
    }

    function showResult() {
      const nickname = prompt('í€´ì¦ˆ ì™„ë£Œ! ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ìµëª…') || 'ìµëª…';
  const scoreRecord = { name: nickname, score: score, total: shuffledQuestions.length };
      // ë­í‚¹ì„ ë°°ì—´ë¡œ êº¼ë‚´ê¸°(ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
let ranking = JSON.parse(localStorage.getItem('quizRanking') || '[]');

// ìƒˆ ê¸°ë¡ ì¶”ê°€
ranking.push(scoreRecord);

// ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬, ìµœëŒ€ 5ê°œë§Œ ìœ ì§€
ranking.sort((a,b) => b.score - a.score);
if (ranking.length > 5) ranking = ranking.slice(0, 5);

// ë‹¤ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
localStorage.setItem('quizRanking', JSON.stringify(ranking));

      document.getElementById('quiz').style.display = 'none';
      let html = `<h2 style="font-size:40px;">ì´ì : ${score} / ${shuffledQuestions.length}</h2>`;
      html += `<div style='font-size:20px;margin-top:10px;'>í•­ëª©ë³„ ì ìˆ˜:</div><ul style='list-style:none;padding:0;'>`;
      selectedCategories.forEach(c => {
        const tot = shuffledQuestions.filter(q => q.category===c).length;
        html += `<li>${c}: ${scoreByCategory[c]} / ${tot}</li>`;
      });
      html += `</ul><button onclick="location.reload()">ë‹¤ì‹œ ì‹œì‘</button>`;
      document.getElementById('result').innerHTML = html;
      document.getElementById('result').style.display = 'block';
      // ê¸°ì¡´ showResult() ë‚´ìš© ëë‚œ ë’¤â€¦

// â‘£ ë­í‚¹ í…Œì´ë¸” ìƒì„±
let rankHtml = '<h3>ğŸ† ë­í‚¹ TOP 5</h3><ol>';
ranking.forEach(r => {
  rankHtml += `<li>${r.name}: ${r.score} / ${r.total}</li>`;
});
rankHtml += '</ol>';

// ê²°ê³¼ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
document.getElementById('result').innerHTML += rankHtml;
#result ol {
  text-align: left;
  display: inline-block;
  padding: 0 20px;
}
#result li {
  margin: 5px 0;
  font-size: 18px;
}

    }

    function playAudio(src) {
      const player = document.getElementById('audioPlayer');
      const raw = src.replace('https://github.com/','https://raw.githubusercontent.com/')
                     .replace('/blob/','/');
      player.src = raw;
      player.style.display = 'block';
      player.load();
      player.play().catch(console.error);
    }

    function dragStart(ev) { ev.dataTransfer.setData('text', ev.target.dataset.index); }
    function allowDrop(ev) { ev.preventDefault(); }
    function drop(ev) {
      ev.preventDefault();
      const idx = ev.dataTransfer.getData('text');
      const slot = ev.target.closest('.drop-slot');
      const orig = document.querySelector(`.drag-item[data-index='${idx}']`);
      if (slot && orig && !slot.querySelector('img')) {
        slot.appendChild(orig);
        orig.draggable = false;
        orig.addEventListener('click', function rm() {
          document.querySelector('.drag-container').appendChild(orig);
          orig.draggable = true;
          orig.removeEventListener('click', rm);
        });
      }
    }
  </script>
</body>
</html>
